<!doctype html>
<html lang="{{locale}}">
<head>
  <meta charset="utf-8">
  <title>{{title}}</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:32px auto;line-height:1.6;color:#1a1a1a}
    h1,h2,h3{margin:0.6em 0}
    .cover{border:2px solid #111;padding:32px;margin-bottom:24px}
    .brand{font-weight:bold;letter-spacing:1px}
    .toc{background:#f4f4f4;padding:16px;border-radius:8px;margin:16px 0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .muted{color:#666}
    table{border-collapse:collapse;width:100%} td,th{border:1px solid #ddd;padding:6px 8px}
    .pyramid{border:1px dashed #ccc;padding:12px;margin:12px 0}
    .qr{float:right;margin:8px}
  </style>
</head>
<body>
  <div class="cover">
    <div class="brand">{{brand}}</div>
    <h1>{{title}}</h1>
    <p><b>Name:</b> {{name}} &nbsp; | &nbsp; <b>DOB:</b> {{dob}} &nbsp; | &nbsp; <b>System:</b> {{system}}{% if role %} &nbsp; | &nbsp; <b>Role:</b> {{role}}{% endif %}</p>
    <p class="muted">{{disclaimer}}</p>
    {% if share_url %}<div class="qr"><img src="{{qr_path}}" width="120" /></div><p class="muted">Share: {{share_url}}</p>{% endif %}
  </div>

  <div class="toc">
    <b>Mục lục / Table of Contents</b>
    <ol>
      <li>Core Numbers</li>
      <li>Pinnacles & Challenges</li>
      <li>Life Pyramid</li>
      <li>Lo Shu Grid</li>
      <li>Context Insights & Habit Packs</li>
    </ol>
  </div>

  <h2>1. Core Numbers</h2>
  <table>
    <tr><th>Life Path</th><td>{{life_path}}</td></tr>
    <tr><th>Birthday</th><td>{{birthday}}</td></tr>
    <tr><th>Expression</th><td>{{expression}}</td></tr>
    <tr><th>Soul Urge</th><td>{{soul_urge}}</td></tr>
    <tr><th>Personality</th><td>{{personality}}</td></tr>
    <tr><th>Maturity</th><td>{{maturity}}</td></tr>
    <tr><th>Personal Year</th><td>{{personal_year}}</td></tr>
  </table>

  <h2>2. Pinnacles & Challenges</h2>
  <div class="grid">
    {% for p in pinnacles %}
      <div>
        <h3>P{{p.index}} — {{p.number}}</h3>
        <p><b>Age:</b> {{p.age_from}} → {{p.age_to}} | <b>Challenge:</b> {{p.challenge}}</p>
        <p><i>Keywords:</i> {{p.theme.keywords|join(", ")}}</p>
        <p><i>Strength:</i> {{p.theme.strength}}</p>
        <p><i>Pitfall:</i> {{p.theme.pitfall}}</p>
        <p><i>Advice:</i> {{p.theme.advice}}</p>
      </div>
    {% endfor %}
  </div>

  <h2>3. Life Pyramid</h2>
  <div class="pyramid">
    <p><b>Base:</b> {{pyr.base}} — <b>Mid:</b> {{pyr.mid}} — <b>Apex:</b> {{pyr.apex}}</p>
    <p class="muted">Base = Month/Day/Year (reduced) → Mid = (M+D, D+Y) → Apex = Mid sum reduced.</p>
  </div>

  <h2>4. Lo Shu Grid</h2>
  <table>
    <tr>
      <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th>
    </tr>
    <tr>
      <td>{{lo_shu["1"]}}</td><td>{{lo_shu["2"]}}</td><td>{{lo_shu["3"]}}</td>
      <td>{{lo_shu["4"]}}</td><td>{{lo_shu["5"]}}</td><td>{{lo_shu["6"]}}</td>
      <td>{{lo_shu["7"]}}</td><td>{{lo_shu["8"]}}</td><td>{{lo_shu["9"]}}</td>
    </tr>
  </table>

  <h2>5. Context Insights & Habit Packs</h2>
  {% for ctx in context %}
    <p>• {{ctx.text}}</p>
    {% if ctx.habits %}
      <ul>
        {% for h in ctx.habits %}<li>{{h}}</li>{% endfor %}
      </ul>
    {% endif %}
  {% endfor %}

</body>
</html>

{% if expert %}
  <h2>Expert Max</h2>
  <p class="muted">{{voice.disclaimer}}</p>
  <h3>Tổng quan</h3>
  <p>{{expert.summary}}</p>
  <div class="grid">
    <div>
      <h3>Điểm mạnh</h3>
      <ul>{% for s in expert.strengths %}<li>{{s}}</li>{% endfor %}</ul>
    </div>
    <div>
      <h3>Điểm mù</h3>
      <ul>{% for s in expert.blindspots %}<li>{{s}}</li>{% endfor %}</ul>
    </div>
  </div>
  <h3>Thói quen khuyến nghị</h3>
  <ul>{% for h in expert.habits %}<li>{{h}}</li>{% endfor %}</ul>
  <h3>If–Then</h3>
  <ul>{% for t in expert.if_then %}<li>{{t}}</li>{% endfor %}</ul>
  <h3>Câu hỏi phản tư</h3>
  <ul>{% for q in expert.questions %}<li>{{q}}</li>{% endfor %}</ul>
  {% if expert.role_hint %}<p class="muted"><b>Gợi ý theo vai trò:</b> {{expert.role_hint}}</p>{% endif %}
{% endif %}


{% if years_detail %}
  <h2>Năm cá nhân</h2>
  {% if years_detail.current %}
    <p><b>Năm {{years_detail.current.year}}:</b> {{years_detail.current.theme}}</p>
    <div class="grid">
      <div><h3>Điểm mạnh</h3><ul>{% for s in years_detail.current.strengths %}<li>{{s}}</li>{% endfor %}</ul></div>
      <div><h3>Điểm mù</h3><ul>{% for s in years_detail.current.pitfalls %}<li>{{s}}</li>{% endfor %}</ul></div>
    </div>
    <h3>Thói quen khuyến nghị</h3>
    <ul>{% for h in years_detail.current.habits %}<li>{{h}}</li>{% endfor %}</ul>
    <p class="muted"><i>Chỉ số gợi ý:</i> {{years_detail.current.metrics|join(", ")}}</p>
  {% endif %}
  {% if years_detail.next %}
    <h2>Năm tiếp theo</h2>
    <p><b>Năm {{years_detail.next.year}}:</b> {{years_detail.next.theme}}</p>
    <p><i>Cầu nối:</i> {{years_detail.next.bridge}}<br/><i>Cảnh báo:</i> {{years_detail.next.caution}}</p>
    <h3>Thói quen chuẩn bị</h3>
    <ul>{% for h in years_detail.next.habits %}<li>{{h}}</li>{% endfor %}</ul>
  {% endif %}
{% endif %}

{% if pinnacle_detail %}
  <h2>Đỉnh cao hiện tại</h2>
  <p><b>P{{pinnacle_detail.index}} — {{pinnacle_detail.number}}</b> ({{pinnacle_detail.age_from}} → {{pinnacle_detail.age_to}})</p>
  <p><i>Chủ đề:</i> {{pinnacle_detail.theme}}{% if pinnacle_detail.challenge %}; <i>Thử thách:</i> {{pinnacle_detail.challenge}}{% endif %}</p>
  <div class="grid">
    <div><h3>Điểm mạnh</h3><ul>{% for s in pinnacle_detail.strengths %}<li>{{s}}</li>{% endfor %}</ul></div>
    <div><h3>Điểm mù</h3><ul>{% for s in pinnacle_detail.pitfalls %}<li>{{s}}</li>{% endfor %}</ul></div>
  </div>
  <h3>Thực hành 3–6 tháng</h3>
  <ul>{% for h in pinnacle_detail.practices_3_6m %}<li>{{h}}</li>{% endfor %}</ul>
  <h3>Câu hỏi đường dài</h3>
  <ul>{% for q in pinnacle_detail.questions %}<li>{{q}}</li>{% endfor %}</ul>
{% endif %}
